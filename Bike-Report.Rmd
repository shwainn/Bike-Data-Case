---
title: "Behavioral Differences of Subscribers to Non-Subscribers for a City Bikeshare Program"
author: "Shawn Ha"
date: "2022-10-20"
output: html_document
---
```{r, setup, echo=FALSE}
library(tidyverse)
library(tidyr)
library(readxl)
library(lubridate)
library(rstudioapi)
library(ggplot2)
library(hexbin)

current_path = rstudioapi::getActiveDocumentContext()$path 
setwd(dirname(current_path ))
getwd() # confirm working directory is location of script

# Read data
bike_2021_10 <- read_excel("202110-divvy-tripdata.xlsx")
bike_2021_11 <- read_excel("202112-divvy-tripdata.xlsx")
bike_2021_12 <- read_excel("202112-divvy-tripdata.xlsx")
bike_2022_01 <- read_excel("202201-divvy-tripdata.xlsx")
bike_2022_02 <- read_excel("202202-divvy-tripdata.xlsx")
bike_2022_03 <- read_excel("202203-divvy-tripdata.xlsx")
bike_2022_04 <- read_excel("202204-divvy-tripdata.xlsx")
bike_2022_05 <- read_excel("202205-divvy-tripdata.xlsx")
bike_2022_06 <- read_excel("202206-divvy-tripdata.xlsx")
bike_2022_07 <- read_excel("202207-divvy-tripdata.xlsx")
bike_2022_08 <- read_excel("202208-divvy-tripdata.xlsx")
bike_2022_09 <- read_excel("202209-divvy-publictripdata.xlsx")
```


# Case Overview

**Cyclistic** is a bike-sharing service based in Chicago with over 5,000 bikes and over 600 docking stations. Users can unlock a bike from any station and lock it at any station. Users can get single ride passes, day passes, or become members for an annual subscription fee. As member subscriptions are more profitable, Cyclistic wants to convert casual riders (who ride with single or day passes) into members (who ride with subscriptions). How do casual riders and members use the service differently, and how can that inform how Cyclistic should market membership to casual riders?

# Business Task

Cyclistic wants to determine how casual users use bikes differently than members. This information would help Cyclistic design new marketing strategies aimed towards converting casual riders into annual members. For example, if casual riders tend to ride as much as or more often than members, Cyclistic can run campaigns to remind casual users of cost savings of signing up as a member (note: with the data available, it cannot be determined how often one user rides). These insights would be useful to the marketing team as well as benefit the company as a whole by helping to increase profits by increasing the number of members.

# Data

### Data Overview

The data is made available by Motivate International Inc. under this [license](https://ride.divvybikes.com/data-license-agreement). While this data is based on real world data, the name of the company has been changed for the purposes of this case study.

The data covers rides that started after March 2020, but we will consider only the last 12 months of data, from October 2021 to September 2022. It includes information like time of the ride (start and end), location of the ride (start station, end station, and start/end latitude/longitude), and the member status of the rider. The data also includes ride and station IDs, but those will not be used for our analysis.

There are some issues with the data, however. Some ride times are incorrect, such as end times being before start times, among other issues. For this reason, the data requires cleaning.

### Data Cleaning

I removed 1,105 observations where the ride lasted for more than 48 hours. I'm assuming that these are a result of a rider forgetting to lock a bike; this is corroborated by all of the long rides being attributed to casual riders, who are more likely to be unfamiliar with the process and not know or forget to lock a bike after use.

I also removed 55 observations where the ride is listed to have ended before it started. This is likely due to some error in data collection and can't be used for analysis.

I removed 63 observations where the ride is listed to have ended the second it started. This is also likely due to some error, but can possibly be a user accidentally immediately locking the bike after unlocking. Either way, the observations don't represent real use cases of the service and therefore wouldn't be useful for analysis.

Similarly, I chose to ignore 113,229 observations where the ride lasted less than one minute. This is an arbitrary threshold and can be refined by observing consumer behaviors, but I felt that this filters out many of the data points that don't represent actual rides. Rides longer than one minute are much more likely to represent a customer legitimately using a bike.

After this, I removed 1 observation which, based on the latitude and longitude, was a test of the system at a house in Quebec.

After this, we are left with 5,601,407 observations, of which all of them represent rides that last between one minute and 48 hours, inclusive.

### Data Transformations

To make use of latitude and longitude data, I used a [Haversine formula](https://en.wikipedia.org/wiki/Haversine_formula) to calculate the great-circle distance between the start station and the end station. Note that this value can be up to 0.5% inaccurate (since the formula applies to a perfect sphere, which the Earth isn't) and would only be accurate if the rider took a straight path to their destination, which is basically impossible. However, this value can be useful to understand if a rider is using the bike to get somewhere or just to ride around, which can be indicated by the stations being far away from one another versus the stations being close by.

```{r, haversine, eval=FALSE}
haversine <- function(lat1, lat2, long1, long2){
  p <- pi / 180
  a <- 0.5 - cos((lat2 - lat1) * p) / 2 +
      cos(lat1 * p) * cos(lat2 * p) * 
      (1 - cos((long2 - long1) * p)) / 2
  
  return(2 * 6371 * asin(sqrt(a)))
}

filtered_bike.data <- filtered_bike.data %>%
  mutate(displacement_km = haversine(start_lat, end_lat, start_lng, end_lng)) %>%
  arrange(desc(displacement_km))
```


Following logically, I added a column for rate of displacement, which divides the displacement above by length of the ride, in minutes. This approximates a speed statistic (since calculating a speed would assume that every bike ride is a straight line to its destination), but also provides insight on if some riders are renting bikes to bike leisurely and are returning the bike at or near their starting location.

For ease of analysis, I added columns that divide the date into day, month, and year, as well as day of week and whether the day is a weekend.

# Hypotheses

With analysis, I aim to answer the following hypotheses:

* Member riders ride more often on weekdays. If true, this would point towards members using bikes to commute to work. 

* Casual riders have a lower rate of displacement. If true, this would corroborate the idea that casual riders are renting bikes for leisure instead of for the purpose of arriving at a new destination. 

* Casual riders ride for longer. If true, this would corroborate if casual riders are renting for leisure, and may be an indicator that single pass riders are riding for longer to make more use out of their money. 

* Casual riders are less likely to ride during winter months than members. If true, this would corroborate that members are using bikes to commute, which would result in them biking in the cold more often than recreational bikers.

Additionally, I aim to answer the following question: 

* Where, if any, are the most common locations for rides to originate?

# Analysis
